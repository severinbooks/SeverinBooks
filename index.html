<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>SeverinBooks</title>
    <link rel="icon" href="images/icons8-book-96.png" type="image/png">
    <script defer data-domain="severinbooks.github.io/severinbooks" src="https://plausible.io/js/script.js"></script>
    <!-- Open Graph Meta-Tags f√ºr WhatsApp & Co -->
  <meta property="og:title" content="SeverinBooks" />
  <meta property="og:description" content="Entdecke √ºber 4'000 christliche eBooks." />
  <meta property="og:image" content="https://severinbooks.github.io/SeverinBooks/images/dlibrary-3267001_1920_SeverinBooks.jpg" />
  <meta property="og:url" content="https://severinbooks.github.io/SeverinBooks" />
  <meta property="og:type" content="website" />
  <meta name="robots" content="noindex, nofollow">
    <style>
        /* Global Styles */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: sans-serif;
            background-color: #1e1e1e;
            color: white;
        }

        #container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 300px;
            background: #2b2b2b;
            padding: 1rem;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
            flex-shrink: 0;
            border-right: 2px solid #444;
        }

        .nav-button {
            background-color: #444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
            transition: background-color 0.2s;
        }

            .nav-button:hover {
                background-color: #666;
            }

        #main {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        #detailPanel {
            width: 300px;
            background: #333;
            padding: 1rem;
            overflow-y: auto;
            height: 100vh;
            flex-shrink: 0;
            border-left: 2px solid #444;
            content-visibility: hidden;
        }

        .cover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
        }

        .cover-item img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

            .cover-item img:hover {
                transform: scale(1.05);
            }

        #detailCover {
            width: 100%;
            max-height: 250px;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        h4 {
            margin: 1rem 0 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reset-btn {
            background: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }

            .reset-btn:hover {
                color: #fff;
                transform: scale(1.1);
            }

        .filter {
            margin-bottom: 1rem;
        }

        .filter-scrollbox {
            max-height: 150px;
            overflow-y: auto;
            background: #1f1f1f;
            padding: 0.3rem 0.5rem;
            border: 1px solid #444;
            border-radius: 4px;
        }

        .filter-click {
            cursor: pointer;
            text-decoration: underline;
        }

            .filter-click:hover {
                color: #1ea1f2;
            }

        #resetFilters {
            width: 100%;
            padding: 0.4rem;
            background: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 1rem;
        }

            #resetFilters:hover {
                background: #555;
            }

        #loanFormPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 1rem;
            border: 2px solid #888;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            width: 350px;
            box-shadow: 0 0 50px 5px rgba(0, 0, 0, 0.7);
        }

            #loanFormPopup input, #loanFormPopup textarea {
                width: 100%;
                margin: 0.3rem 0;
                padding: 0.4rem;
                border-radius: 4px;
                border: 1px solid #666;
                background: #333;
                color: white;
            }

            #loanFormPopup button {
                margin-top: 0.5rem;
                width: 100%;
                padding: 0.5rem;
                background: #1ea1f2;
                border: none;
                color: white;
                border-radius: 4px;
                cursor: pointer;
                font-size: medium;
            }

                #loanFormPopup button:hover {
                    background: #0e81c2;
                }

        #loanFormPopupClose {
            text-align: right;
            cursor: pointer;
            font-size: 1.2rem;
            color: #aaa;
        }

            #loanFormPopupClose:hover {
                color: #777777;
            }

        #loanButton {
            margin-top: 1rem;
            background: #1ea1f2;
            border: none;
            padding: 0.5rem;
            width: 100%;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

            #loanButton:hover {
                background: #0e81c2;
            }
        #bookCount {
    position: sticky;
    bottom: 0;
    background: #2b2b2b;
    padding-top: 1rem;
    font-size: 0.9rem;
    border-top: 1px solid #444;
    text-align: center;
        }

    #sidebar {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#sidebar .filters {
    flex-grow: 1;
    padding-bottom: 1rem;
}

#bookCountBar {
    padding: 0.6rem;
    background: #1a1a1a;
    border-top: 2px solid #444;
    text-align: center;
    font-size: 0.9rem;
    flex-shrink: 0;
}


#sidebarContainer {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 300px;
    background: #2b2b2b;
    border-right: 2px solid #444;
    flex-shrink: 0;
}

#sidebar {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

#bookCountBar {
    padding: 0.6rem 1rem;
    border-top: 2px solid #444;
    background-color: #252525;
    text-align: left;
    font-size: 0.9rem;
    color: #ddd;
}

.filter-label {
  display: flex;
  align-items: flex-start;
  gap: 0.3em;
  margin-bottom: 0.05em;
  line-height: 1.3;
}

.filter-text {
  flex: 1;
  word-break: break-word;
}

#coverOverlay {
  position: fixed; /* bleibt beim Scrollen sichtbar */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none; /* Klicks durch Overlay durchlassen */
  z-index: 1000; /* √ºber allen anderen Elementen */
  max-width: 80vw;
  max-height: 80vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#coverOverlay img {
  max-width: 70vw;
  max-height: 80vh;
  width: auto;
  height: auto;
  border-radius: 10px;
  box-shadow: 0 0 50px 11px rgba(0,0,0,0.7);
}

.cover-item {
  position: relative;
  width: 100%;
  aspect-ratio: 2/3;
  background-color: #2d2d2d; /* etwas heller als #1e1e1e */
  border-radius: 6px;
  overflow: hidden;
}

.cover-item.loading::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 32px;
  height: 32px;
  border: 4px solid #999;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  transform: translate(-50%, -50%);
}

@keyframes spin {
  to {
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

.cover-item img {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
}


    </style>
</head>
<body>
    <div id="container">
        <div id="sidebarContainer">

        <div id="sidebar">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button onclick="location.href='ueber.html'" class="nav-button">‚ÑπÔ∏è √úber</button>
                <button onclick="location.href='impressum.html'" class="nav-button">üìÑ Impressum</button>
            </div>
            <div class="filters">
            <div class="filter">
                <button id="resetFilters">üîÑ Alle Filter zur√ºcksetzen</button>
            </div>

            <div class="filter">
                <h4>üîç Suche: <button class="reset-btn" data-filter="search">üîÑ</button></h4>
                <input type="text" id="search" style="width: 100%;">
            </div>

            <div class="filter">
                <h4>üë§ Autoren: <button class="reset-btn" data-filter="authors">üîÑ</button></h4>
                <div id="authorsFilter" class="filter-scrollbox"></div>
            </div>

            <div class="filter">
                <h4>üè∑Ô∏è Tags: <button class="reset-btn" data-filter="tags">üîÑ</button></h4>
                <div id="tagsFilter" class="filter-scrollbox"></div>
            </div>

            <div class="filter">
                <h4>üó£Ô∏è Sprachen: <button class="reset-btn" data-filter="languages">üîÑ</button></h4>
                <div id="languagesFilter" class="filter-scrollbox"></div>
            </div>

            <div class="filter">
                <h4>üìö Serien: <button class="reset-btn" data-filter="series">üîÑ</button></h4>
                <div id="seriesFilter" class="filter-scrollbox"></div>
            </div>

            <div class="filter">
                <h4>üíæ Formate: <button class="reset-btn" data-filter="formats">üîÑ</button></h4>
                <div id="formatsFilter" class="filter-scrollbox"></div>
            </div>

            <div class="filter">
                <h4>üè¢ Verlage: <button class="reset-btn" data-filter="publisher">üîÑ</button></h4>
                <div id="publisherFilter" class="filter-scrollbox"></div>
            </div>
            </div>

        </div>

        <div id="bookCountBar">
          <span id="bookCountIcon">üìñ</span>
          <span id="bookCountText">0 von 0 eBooks</span>
        </div>
        </div>

        <div id="main">
            <div class="cover-grid" id="coverGrid"></div>
            <div id="coverOverlay" style="display:none;">
                <img id="overlayCoverImage" src="" alt="Gro√ües Cover">
            </div>
        </div>

        <div id="detailPanel">
            <img id="detailCover" src="" alt="Buchcover">
            <h2 id="detailTitle"></h2>
            <p><strong>Autor(en):</strong> <span id="detailAuthor"></span></p>
            <p><strong>Verlag:</strong> <span id="detailPublisher" class="filter-click" data-filter="publisher"></span></p>
            <p><strong>Tags:</strong> <span id="detailTags"></span></p>
            <p><strong>Serie:</strong> <span id="detailSeries" class="filter-click" data-filter="series"></span></p>
            <p><strong>Format:</strong> <span id="detailFormats" class="filter-click" data-filter="formats"></span></p>
            <p><strong>Sprache:</strong> <span id="detailLang"></span></p>
            <button id="loanButton">Ich m√∂chte dieses eBook ausleihen</button>
        </div>
    </div>

    <!-- Popup-Formular -->
    <div id="loanFormPopup">
        <div id="loanFormPopupClose" onclick="document.getElementById('loanFormPopup').style.display='none'">‚úñ</div>
        <h3>Ausleihanfrage</h3>
        <input type="text" id="vorname" placeholder="Vorname">
        <input type="text" id="nachname" placeholder="Nachname">
        <input type="email" id="email" placeholder="E-Mail">
        <textarea id="beziehung" placeholder="Woher kennen wir uns?"></textarea>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" id="rememberMe" style="margin-left: 0.1rem; margin-right: 0.5rem; width: 16px; height: 16px;">
          Meine Eingaben merken
        </label>

        <button onclick="sendLoanRequest()">Senden</button>
    </div>

    <script>
        let books = [];
        function debounce(fn, delay) {
            let timer;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        let currentBook = null;
        let activeFilters = {
            authors: new Set(),
            tags: new Set(),
            languages: new Set(),
            series: new Set(),
            formats: new Set(),
            publisher: new Set()
        };

        fetch('books.json')
  .then(res => res.json())
  .then(data => {
    // B√ºcher mit Tag "√úbersetzt" herausfiltern
    books = data.filter(book => {
      const tags = (book.tags || "").split(",").map(tag => tag.trim().toLowerCase());
      return !tags.includes("√ºbersetzt");
    }).sort((a, b) =>
      (a.series || "").localeCompare(b.series || "") ||
      (a.author_sort || a.authors || "").localeCompare(b.author_sort || b.authors || "")
    );

    renderBooks(books);
    buildFilters(books);
    updateBookCount(books); // initialer Z√§hler
  })
  .catch(err => {
    console.error("Fehler beim Laden von books.json:", err);
    alert("B√ºcher konnten leider nicht geladen werden.");
  });


        function renderBooks(data) {
  const grid = document.getElementById("coverGrid");
  grid.innerHTML = "";

  data.forEach(book => {
    const div = document.createElement("div");
    div.className = "cover-item loading"; // Start als "loading"

    const img = document.createElement("img");
    img.alt = book.title;
    img.loading = "eager"; // sofort laden

    img.addEventListener("load", () => {
  div.classList.remove("loading");
});

img.addEventListener("error", () => {
  div.classList.remove("loading");
  img.src = "images/fallback-image.jpg"; // Fallback-Bild bei Fehler
});

img.src = book.cover;

    img.onclick = () => showDetails(book);

    div.appendChild(img);
    grid.appendChild(div);
  });
}


        function updateBookCount(filtered) {
    const total = books.length;
    const shown = filtered.length;
    document.getElementById("bookCountText").textContent = `${filtered.length} von ${books.length} eBooks`;

}


        function buildFilters(data) {
    const fields = {
        authors: "authorsFilter",
        tags: "tagsFilter",
        languages: "languagesFilter",
        series: "seriesFilter",
        formats: "formatsFilter",
        publisher: "publisherFilter"
    };

    for (let key in fields) {
        const div = document.getElementById(fields[key]);
        let values = [];

if (key === "authors") {
    let authorsSet = new Set();

    data.forEach(book => {
        let authors = (book.authors || "").split(/\s*&\s*/).map(a => a.trim());
        authors.forEach(author => authorsSet.add(author));
    });

    let authors = [...authorsSet];

    // Hilfsfunktion zum Sortieren nach Nachname (letztes Wort)
    const sortKey = name => {
        const parts = name.trim().split(/\s+/);
        return (parts[parts.length - 1] || "").toLowerCase();
    };

    authors.sort((a, b) => sortKey(a).localeCompare(sortKey(b), 'de'));

    values = authors;

        } else {
            // Standard: kommaseparierte Strings aufsplitten, trimmen, filtern, sortieren
            values = [...new Set(data.map(b => (b[key] || "").split(",")).flat().map(s => s.trim()).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'de'));
        }

        div.innerHTML = values.map(val => `
  <label class="filter-label">
    <input type="checkbox" data-cat="${key}" value="${val}">
    <span class="filter-text">${val}</span>
  </label>
`).join("");

    }
}


        const debouncedFilter = debounce(applyFilters, 300);
        document.getElementById("search").addEventListener("input", debouncedFilter);


        document.getElementById("sidebar").addEventListener("change", e => {
            if (e.target.matches("input[type=checkbox]")) {
                const cat = e.target.dataset.cat;
                if (e.target.checked) {
                    activeFilters[cat].add(e.target.value);
                } else {
                    activeFilters[cat].delete(e.target.value);
                }
                applyFilters();
            }
        });

        function applyFilters() {
            const q = document.getElementById("search").value.toLowerCase();

            const filtered = books.filter(b => {
                if (q && !(b.title + b.authors + b.tags).toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").includes(q.normalize("NFD").replace(/\p{Diacritic}/gu, ""))) return false;

                for (let cat in activeFilters) {
                    if (activeFilters[cat].size > 0) {
                        const bookVal = (b[cat] || "").split(cat === "authors" ? /\s*&\s*/ : ",").map(s => s.trim());
                        if (![...activeFilters[cat]].every(f => bookVal.includes(f))) return false;
                    }
                }
                return true;
            });

            renderBooks(filtered);
            updateBookCount(filtered);
        }

        function showDetails(book) {
    currentBook = book;

    const detailCover = document.getElementById("detailCover");

    // Tempor√§r ausblenden, um "falsches" Bild zu verhindern
    detailCover.style.visibility = "hidden";

    // Sicherheitskopie des Pfads
    const expectedCoverSrc = book.cover;

    detailCover.onload = () => {
        // Nur anzeigen, wenn das Bild zum aktuell ausgew√§hlten Buch geh√∂rt
        if (currentBook.cover === expectedCoverSrc) {
            detailCover.style.visibility = "visible";
        }
    };

    detailCover.onerror = () => {
        detailCover.src = "images/fallback-image.jpg";
        detailCover.style.visibility = "visible";
    };

    detailCover.src = book.cover;

    // Jetzt die Metadaten bef√ºllen
    document.getElementById("detailPanel").style.contentVisibility = "visible";
    document.getElementById("detailTitle").textContent = book.title;
    document.getElementById("detailAuthor").innerHTML = (book.authors || "")
        .split(/\s*&\s*/)
        .map(author => `<span class="filter-click" data-filter="authors">${author.trim()}</span>`)
        .join(", ");
    document.getElementById("detailPublisher").textContent = book.publisher;
    document.getElementById("detailTags").innerHTML = (book.tags || "").split(",").map(tag =>
        `<span class="filter-click" data-filter="tags">${tag.trim()}</span>`).join(", ");
    document.getElementById("detailSeries").textContent = book.series || "";
    document.getElementById("detailFormats").textContent = book.formats || "";
    document.getElementById("detailLang").innerHTML = (book.languages || "")
        .split(",")
        .map(lang => `<span class="filter-click" data-filter="languages">${lang.trim()}</span>`)
        .join(", ");
}


const detailCover = document.getElementById("detailCover");
const coverOverlay = document.getElementById("coverOverlay");
const overlayCoverImage = document.getElementById("overlayCoverImage");

// Funktion Overlay anzeigen
function showOverlay(src) {
  overlayCoverImage.src = src;
  coverOverlay.style.display = "flex";
}

// Funktion Overlay verstecken
function hideOverlay() {
  coverOverlay.style.display = "none";
}

// Hover f√ºr Desktop
detailCover.addEventListener("mouseenter", () => {
  showOverlay(detailCover.src);
});
detailCover.addEventListener("mouseleave", () => {
  hideOverlay();
});

// Tap f√ºr Mobil (Toggle bei Klick/Touch)
let overlayVisible = false;
detailCover.addEventListener("click", () => {
  if (overlayVisible) {
    hideOverlay();
    overlayVisible = false;
  } else {
    showOverlay(detailCover.src);
    overlayVisible = true;
  }
});

// Zus√§tzlich: Tippen irgendwo au√üerhalb schlie√üt das Overlay (z.B. beim Mobilger√§t)
document.body.addEventListener("click", (e) => {
  if (overlayVisible && !detailCover.contains(e.target) && !coverOverlay.contains(e.target)) {
    hideOverlay();
    overlayVisible = false;
  }
});


        document.getElementById("detailPanel").addEventListener("click", e => {
    if (e.target.classList.contains("filter-click")) {
        const cat = e.target.dataset.filter;
        const val = e.target.textContent.trim();

        // Alle Filter zur√ºcksetzen
        for (let key in activeFilters) {
            activeFilters[key].clear();
            document.querySelectorAll(`#sidebar input[data-cat="${key}"]`).forEach(cb => cb.checked = false);
        }

        // Nur den neuen Filter setzen
        activeFilters[cat].add(val);
        const cb = [...document.querySelectorAll(`#sidebar input[data-cat="${cat}"]`)].find(c => c.value === val);
        if (cb) cb.checked = true;

        applyFilters();
    }
});


        document.querySelectorAll(".reset-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const cat = btn.dataset.filter;
                if (cat === "search") {
                    document.getElementById("search").value = "";
                } else {
                    activeFilters[cat].clear();
                    document.querySelectorAll(`#sidebar input[data-cat="${cat}"]`).forEach(cb => cb.checked = false);
                }
                applyFilters();
            });
        });

        document.getElementById("resetFilters").addEventListener("click", () => {
            document.getElementById("search").value = "";
            for (let cat in activeFilters) activeFilters[cat].clear();
            document.querySelectorAll("#sidebar input[type=checkbox]").forEach(cb => cb.checked = false);
            applyFilters();
        });

        document.getElementById("loanButton").addEventListener("click", () => {
            document.getElementById("loanFormPopup").style.display = "block";

        const saved = localStorage.getItem("loanFormData");
        if (saved) {
            try {
                const data = JSON.parse(saved);
                document.getElementById("vorname").value = data.vorname || "";
                document.getElementById("nachname").value = data.nachname || "";
                document.getElementById("email").value = data.email || "";
                document.getElementById("beziehung").value = data.bez || "";
                document.getElementById("rememberMe").checked = true;
            } catch (e) {
                console.warn("Fehler beim Laden gespeicherter Daten:", e);
            }
        } else {
            document.getElementById("vorname").value = "";
            document.getElementById("nachname").value = "";
            document.getElementById("email").value = "";
            document.getElementById("beziehung").value = "";
            document.getElementById("rememberMe").checked = false;
        }
        });

        function sendLoanRequest() {
            const vorname = document.getElementById("vorname").value;
            const nachname = document.getElementById("nachname").value;
            const email = document.getElementById("email").value;
            const bez = document.getElementById("beziehung").value;
            const remember = document.getElementById("rememberMe").checked;

            // Nur speichern, wenn Checkbox gesetzt ist
           if (remember) {
                localStorage.setItem("loanFormData", JSON.stringify({
                    vorname,
                    nachname,
                    email,
                    bez
                }));
            } else {
                localStorage.removeItem("loanFormData");
            }  

            const subject = encodeURIComponent("eBook-Ausleihanfrage: " + currentBook.title);
            const body = encodeURIComponent(`Ausleih-Anfrage\n\nVorname: ${vorname}\nNachname: ${nachname}\nE-Mail: ${email}\n\nBeziehung: ${bez}\n\nBuchdetails:\nTitel: ${currentBook.title}\nAutor(en): ${currentBook.authors}\nVerlag: ${currentBook.publisher}\nSerie: ${currentBook.series}\nSprache: ${currentBook.languages}\nTags: ${currentBook.tags}`);

            window.location.href = `mailto:severinbooks@gmx.ch?subject=${subject}&body=${body}`;
            document.getElementById("loanFormPopup").style.display = "none";
        }
    </script>
</body>
</html>
